---
title: "berka_bank_analysis"
author: '@RodriGonca'
date: "6/27/2019"
output: html_document
---

```{r setup, echo=FALSE, include=FALSE}
#source("step_00_config_environment.R")
#knitr::opts_knit$set(root.dir = wd)
#source("./scripts/berka_bank_analysis.R")

library(tidyverse)

```


# Berka Bank Análise exploratória de Dados

## Domain
Onde upon a time, there was a bank offering services to private persons.
The services include managing of accounts, offerings loans, etc.

## Task Descripion

The bank wants to improve their services. For instance, the bank managers have only vague idea, who is a good client (whom to offer some additional services) and who is a bad client (whom to watch carefully to monimize the bank loses).

Fortunately, the bank stores data about their clients, the accounts (transactions within several months), the loans already granted, the credit cards issued.

The bank managers hope to improve their undestanding of customers and seed specific actions to improve services.

A mere application of discovery tool will not be convincing for them.

## Data Model

```{r data_model_pic, echo=FALSE, out.width = '100%'}
knitr::include_graphics("../images/data_model.png")
```

## Loan Exploration

```{r Loan_status_by_region, echo=TRUE, out.width = '100%', error=TRUE}
left_join(loan, disposition, by = 'account_id') %>% 
  left_join(client, by = 'client_id') %>% 
  left_join(district, by = 'district_id') %>% 
  group_by(region, contract_status, defaulter) %>% 
  summarise(count = n(),
            amount = sum(amount)) %>% 
  group_by(region, contract_status) %>% 
  mutate(count_contract_status = sum(count),
         amount_contract_status = sum(amount)) %>% 
  group_by(region) %>% 
  mutate(count_region = sum(count),
         amount_region = sum(amount)) %>% 
  ggplot(aes(x = defaulter, y = contract_status, fill = count / count_region)) +
  geom_bin2d(stat = 'identity') +
  geom_text(aes(label = paste(round(count / count_region * 100, 2), '%')), color = 'white') +
  facet_wrap(~region) +
  theme_economist() +
  theme(legend.position = 'none', panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  labs(x = 'Defaulter', y = 'Contract Status', title = 'Loan Contract Status by Region Heatmap')

```

```{r Loan_status_by_gender, echo=TRUE, out.width = '100%', error=TRUE}
left_join(loan, disposition, by = 'account_id') %>%
  left_join(client, by = 'client_id') %>% 
  left_join(district, by = 'district_id') %>% 
  group_by(gender, contract_status, defaulter) %>% 
  summarise(count = n(),
            amount = sum(amount)) %>% 
  group_by(gender, contract_status) %>% 
  mutate(count_contract_status = sum(count),
         amount_contract_status = sum(amount)) %>% 
  group_by(gender) %>% 
  mutate(count_gender = sum(count),
         amount_gender = sum(amount)) %>% 
  ggplot(aes(x = defaulter, y = contract_status, fill = count / count_gender)) +
    geom_bin2d(stat = 'identity') +
    geom_text(aes(label = paste(round(count / count_gender * 100, 2), '%')), color = 'white') +
    facet_wrap(~gender) +
    theme_economist() +
    theme(legend.position = 'none', panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    labs(x = 'Defaulter',
         y = 'Contract Status',
         title = 'Loan Contract Status by Gender Heatmap')
```

```{r Loan_status_by_age_bin, echo=TRUE, out.width = '100%', error=TRUE}
left_join(loan, disposition, by = 'account_id') %>%
  left_join(client, by = 'client_id') %>% 
  left_join(district, by = 'district_id') %>% 
  group_by(age_bin, contract_status, defaulter) %>% 
  summarise(count = n(),
            amount = sum(amount)) %>% 
  group_by(age_bin, contract_status) %>% 
  mutate(count_contract_status = sum(count),
         amount_contract_status = sum(amount)) %>% 
  group_by(age_bin) %>% 
  mutate(count_age_bin = sum(count),
         amount_age_bin = sum(amount)) %>% 
  ggplot(aes(x = defaulter, y = contract_status, fill = count / count_age_bin)) +
    geom_bin2d(stat = 'identity') +
    geom_text(aes(label = paste(round(count / count_age_bin * 100, 2), '%')), color = 'white') +
    facet_wrap(~age_bin) +
    theme_economist() +
    theme(legend.position = 'none', panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    labs(x = 'Defaulter',
         y = 'Contract Status',
         title = 'Loan Contract Status by Age Group Heatmap')
```

## Account Balance Exploration

```{r avg_account_balance_by_gender_and_region, echo=TRUE, out.width = '100%', error=TRUE}
account_balance <- arrange(transaction, desc(date), account_id) %>%
  group_by(account_id) %>%
  mutate(avg_balance = mean(balance)) %>%
  filter(row_number() == 1) %>% 
  select(account_id, date, balance, avg_balance)

colnames(account_balance) <- c("account_id", "last_transaction_date", 'account_balance', 'avg_balance')

left_join(account_balance, disposition, by = 'account_id') %>%
  left_join(client, by = 'client_id') %>% 
  left_join(district, by = 'district_id') %>% 
  filter(type == 'Owner') %>% 
  ggplot(aes(avg_balance)) +
    geom_density(alpha = 0.5, aes(fill = gender)) +
    scale_x_continuous(labels = scales::comma) +
    labs(title = 'Average Account Balance Distribution by Gender and Region') +
    theme_economist() +
    facet_wrap(~region)

```
